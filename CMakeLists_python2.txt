# ADD: Top-level CMakeLists.txt (with CUDA toolkit)

cmake_minimum_required(VERSION 3.18)

project(CUDA2_MD LANGUAGES CXX CUDA)

# ---- language setup ----
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CUDA_STANDARD 17)
set(CMAKE_CUDA_STANDARD_REQUIRED ON)

# ---- CUDA toolkit (for cuda_runtime.h etc.) ----
find_package(CUDAToolkit REQUIRED)

# ---- Python 2.7 + NumPy ----
find_package(Python2 COMPONENTS Interpreter Development NumPy REQUIRED)

execute_process(
    COMMAND "${Python2_EXECUTABLE}" "-c" "import matplotlib"
    RESULT_VARIABLE MATPLOTLIB_IMPORT_RESULT
)
if(NOT MATPLOTLIB_IMPORT_RESULT EQUAL 0)
    message(FATAL_ERROR "Python2 matplotlib module not found for interpreter: ${Python2_EXECUTABLE}")
endif()

# ---- nlohmann-json via vcpkg ----
find_package(nlohmann_json CONFIG REQUIRED)
find_package(MPI REQUIRED)

# ---- project directories ----
set(PROJECT_ROOT "${CMAKE_CURRENT_SOURCE_DIR}")
set(INCLUDE_DIR "${PROJECT_ROOT}/include")
set(CUDA_DIR    "${PROJECT_ROOT}/cuda")
set(SRC_DIR     "${PROJECT_ROOT}/src")
set(TESTS_DIR   "${PROJECT_ROOT}/tests")
set(MATPLOTLIB_CPP_DIR "${PROJECT_ROOT}/external/matplotlib-cpp")

# ---- core sources ----
file(GLOB_RECURSE PROJECT_HEADERS "${INCLUDE_DIR}/*.hpp")
file(GLOB_RECURSE PROJECT_SOURCES "${SRC_DIR}/*.cpp")
file(GLOB_RECURSE PROJECT_CUDA    "${CUDA_DIR}/*.cu")

add_library(md_particle_lib
    ${PROJECT_HEADERS}
    ${PROJECT_SOURCES}
    ${PROJECT_CUDA}
)

target_include_directories(md_particle_lib
    PUBLIC
        "${PROJECT_ROOT}"
        "${INCLUDE_DIR}"
        "${MATPLOTLIB_CPP_DIR}"
        ${Python2_INCLUDE_DIRS}
        ${Python2_NumPy_INCLUDE_DIRS}
        ${CUDAToolkit_INCLUDE_DIRS}
)

target_link_libraries(md_particle_lib
    PUBLIC
        Python2::Python
        nlohmann_json::nlohmann_json
        CUDA::cudart
        MPI::MPI_CXX
)

# ---- test executables: tests/*/*.cpp ----
file(GLOB_RECURSE TEST_SOURCES "${TESTS_DIR}/*/*.cpp")

foreach(test_src IN LISTS TEST_SOURCES)
    get_filename_component(test_name "${test_src}" NAME_WE)
    get_filename_component(test_dir "${test_src}" DIRECTORY)
    get_filename_component(test_dir_name "${test_dir}" NAME)

    set(exe_name "${test_dir_name}_${test_name}")

    add_executable("${exe_name}" "${test_src}")

    target_link_libraries("${exe_name}"
        PRIVATE
            md_particle_lib
    )

    target_include_directories("${exe_name}"
        PRIVATE
            "${PROJECT_ROOT}"
            "${INCLUDE_DIR}"
            "${MATPLOTLIB_CPP_DIR}"
            ${Python2_INCLUDE_DIRS}
            ${Python2_NumPy_INCLUDE_DIRS}
            ${CUDAToolkit_INCLUDE_DIRS}
    )
endforeach()

# End of Add
